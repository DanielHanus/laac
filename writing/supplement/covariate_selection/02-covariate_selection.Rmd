---
title: "Covariate Selection via Projection Prediction Inference"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    code_folding: show
    number_sections: yes
  html_document:
    toc: yes
    df_print: paged
---

```{r setup, include = F}
library(tidyverse)
library(brms)
library(projpred)
library(bayesplot)

# retrieve # of cores
ncores <- parallel::detectCores()

# for output clarity
options(scipen = 999)

# load data
load("tasks_ppi.Rda")

# set seed
set.seed(2021)
```

```{r regression formula, include = F}
# covariate needed for projection prediction
# placed here to compare with formula
all_fixed_effects <- c("sick_severity",       
                       "test_day", "test_tp", 
                       "rel_rank",
                       "observer", 
                       "age", "time_in_leipzig", 
                       "sex", 
                       "rearing", 
                       "le_mean", 
                       "dist_mean",
                       "time_outdoors", 
                       "sociality")

fm <- formula(cogn ~ sick_severity +                    
                test_day + test_tp +                
                rel_rank + # rank_gmc +
                observer + 
                age + time_in_leipzig +
                sex + 
                rearing +
                le_mean + # le_max + # le_present +         
                dist_mean + # dist_max + # + dist_present +
                time_outdoors +
                sociality + # sociality_total
                # heat_mod + # heat +
                (1|subject)                         
              ) 

fm_gaze <- update(fm, . ~ . + day2)  # add day2 covariate to gaze task model
```

# Reference Model: 2-level Multilevel Model

A multilevel model for each task is fit. The models do not random slope terms.

```{r fit multilevel models, include = F}
m_cau_2l <- brm(fm, data = t_cau, 
                warmup = 1e3, iter = 3e3, cores = ncores, chains = 2, 
                seed = 2021,
                save_pars = save_pars(all = TRUE)
                )
m_inf_2l <- brm(fm, data = t_inf, 
                warmup = 1e3, iter = 3e3, cores = ncores, chains = 2, 
                seed = 2021,
                save_pars = save_pars(all = TRUE)
                )
m_quant_2l <- brm(fm, data = t_quant, 
                  warmup = 1e3, iter = 3e3, cores = ncores, chains = 2, 
                  seed = 2021,
                  save_pars = save_pars(all = TRUE)
                  )
m_gaze_2l <- brm(fm_gaze, data = t_gaze, 
                 warmup = 1e3, iter = 3e3, cores = ncores, chains = 2, 
                 seed = 2021,
                 save_pars = save_pars(all = TRUE)
                 )
```

## Summary output of MLMs for each task

```{r echo = F}
summary(m_cau_2l)
summary(m_inf_2l)
summary(m_quant_2l)
summary(m_gaze_2l)
```

# Projection Prediction Inference

## Covariate Selection -- fast version

**Disclaimer:**
* Choosing the relevant covariates is based on inspection elpd/rmse plots.
*    `varsel` is used as a quick inspection tool; `cv_varsel` for final covariate selection

```{r setup for vs function}
# delay random intercept to last place so that it doesn't soak up all the variance
s_terms <- c("1", all_fixed_effects, 
             paste0(paste(all_fixed_effects, collapse = " + "), " + (1 | subject)")) 
s_terms_gaze <- c("1", c(all_fixed_effects, "day2"), 
                  paste0(paste(c(all_fixed_effects, "day2"), collapse = " + "), " + (1 | subject)"))
```

```{r include = F}
refM_cau <- get_refmodel(m_cau_2l)
refM_inf <- get_refmodel(m_inf_2l)
refM_quant <- get_refmodel(m_quant_2l)
refM_gaze <- get_refmodel(m_gaze_2l)
```

```{r message = FALSE, warning = FALSE}
vs_cau <- varsel(refM_cau, search_terms = s_terms)
summary(vs_cau)
# plot(vs_cau, stats = c('elpd', 'rmse'))

# randint_ind_vscau <- length(solution_terms(vs_cau))
# relevant_cov_vscau <- c(1:3, randint_ind_vscau)  # indices for relevant covariates

# proj_cau <- project(vs_cau, solution_terms = relevant_cov_vscau)
# mcmc_areas(as.matrix(proj_cau), 
#            pars = solution_terms(vs_cau)[relevant_cov_vscau])
```

```{r message = FALSE, warning = FALSE}
vs_inf <- varsel(refM_inf, search_terms = s_terms)
summary(vs_inf) 
# plot(vs_inf, stats = c('elpd', 'rmse'))

# randint_ind_vsinf <- length(solution_terms(vs_inf))
# relevant_cov_vsinf <- c(1:2, randint_ind_vsinf)  # indices for relevant covariates

# proj_inf <- project(vs_inf, solution_terms = relevant_cov_vsinf)
# mcmc_areas(as.matrix(proj_inf), 
#            pars = solution_terms(vs_inf)[relevant_cov_vsinf])
```

```{r message = FALSE, warning = FALSE}
vs_quant <- varsel(refM_quant, search_terms = s_terms)
summary(vs_quant)
# plot(vs_quant, stats = c('elpd', 'rmse'))

# randint_ind_vsquant <- length(solution_terms(vs_quant))
# relevant_cov_vsquant <- c(1:7, randint_ind_vsquant)  # indices for relevant covariates

# proj_quant <- project(vs_quant, solution_terms = relevant_cov_vsquant)
# mcmc_areas(as.matrix(proj_quant), 
#            pars = solution_terms(vs_quant)[relevant_cov_vsquant])
```

```{r message = FALSE, warning = FALSE}
vs_gaze <- varsel(refM_gaze, search_terms = s_terms_gaze)
summary(vs_gaze)
# plot(vs_gaze, stats = c('elpd', 'rmse'))

# randint_ind_vsgaze <- length(solution_terms(vs_gaze))
# relevant_cov_vsgaze <- c(1:7, randint_ind_vsgaze)  # indices for relevant covariates

# proj_gaze <- project(vs_gaze, solution_terms = relevant_cov_vsgaze)
# mcmc_areas(as.matrix(proj_gaze), 
#            pars = solution_terms(vs_gaze)[relevant_cov_vsgaze])
```

## Covariate Selection --  LOO cross validation

### Causality
```{r include = F}
cvs_cau <- cv_varsel(refM_cau, 
                     search_terms = s_terms, 
                     cv_method = "loo", method = "forward")
```

```{r message = FALSE, warning = FALSE}
summary(cvs_cau); plot(cvs_cau, stats = c('elpd', 'rmse'))

randint_ind_cvscau <- length(solution_terms(cvs_cau))
relevant_cov_cvscau <- c(1:3, randint_ind_cvscau)  # indices for relevant covariates

# Build projected posterior
proj_cau_cv <- project(cvs_cau, solution_terms = relevant_cov_cvscau)
round(colMeans(as.matrix(proj_cau_cv)), 1)
round(posterior_interval(as.matrix(proj_cau_cv)), 1)
mcmc_areas(as.matrix(proj_cau_cv), pars = solution_terms(cvs_cau)[relevant_cov_cvscau])
```
<br/><br/>
The following covariates have predictive information (**relevant**): `(1 | subject)`, `sick_severity`, `dist_mean`, `time_in_leipzig`

### Inference
```{r include = F}
cvs_inf <- cv_varsel(refM_inf, 
                     search_terms = s_terms, 
                     cv_method = "loo", method = "forward")
summary(cvs_inf); plot(cvs_inf, stats = c('elpd', 'rmse'))
```

```{r message = FALSE, warning = FALSE}
randint_ind_cvsinf <- length(solution_terms(cvs_inf))
relevant_cov_cvsinf <- c(1:2, randint_ind_cvsinf)  # indices for relevant covariates

# Build projected posterior
proj_inf_cv <- project(cvs_inf, solution_terms = relevant_cov_cvsinf)
round(colMeans(as.matrix(proj_inf_cv)), 1)
round(posterior_interval(as.matrix(proj_inf_cv)), 1)
mcmc_areas(as.matrix(proj_inf_cv), pars = solution_terms(cvs_inf)[relevant_cov_cvsinf])
```
<br/><br/>
The following covariates have predictive information (**relevant**): `(1 | subject)`, `time_in_leipzig`, `age`

### Quantity
```{r include = F}
cvs_quant <- cv_varsel(refM_quant, 
                       search_terms = s_terms, 
                       cv_method = "loo", method = "forward")
```

```{r message = FALSE, warning = FALSE}
summary(cvs_quant); plot(cvs_quant, stats = c('elpd', 'rmse'))

randint_ind_cvsquant <- length(solution_terms(cvs_quant))
relevant_cov_cvsquant <- c(1:7, randint_ind_cvsquant)  # indices for relevant covariates

# Build projected posterior
proj_quant_cv <- project(cvs_quant, solution_terms = relevant_cov_cvsquant)
round(colMeans(as.matrix(proj_quant_cv)), 1)
round(posterior_interval(as.matrix(proj_quant_cv)), 1)
mcmc_areas(as.matrix(proj_quant_cv), pars = solution_terms(cvs_quant)[relevant_cov_cvsquant])
```
<br/><br/>
The following covariates have predictive information (**relevant**): `(1 | subject)`, `time_in_leipzig`, `rearing`, `rel_rank`, `observer`, `test_tp`, `sex`, `sick_severity`

### Gaze
```{r include = F}
cvs_gaze <- cv_varsel(refM_gaze, 
                      search_terms = s_terms_gaze, 
                      cv_method = "loo", method = "forward")
```

```{r message = FALSE, warning = FALSE}
summary(cvs_gaze); plot(cvs_gaze, stats = c('elpd', 'rmse'))

randint_ind_cvsgaze <- length(solution_terms(cvs_gaze))
relevant_cov_cvsgaze <- c(1:8, randint_ind_cvsgaze)  # indices for relevant covariates

# Build projected posterior
proj_gaze_cv <- project(cvs_gaze, solution_terms = relevant_cov_cvsgaze)
round(colMeans(as.matrix(proj_gaze_cv)), 1)
round(posterior_interval(as.matrix(proj_gaze_cv)), 1)
mcmc_areas(as.matrix(proj_gaze_cv), pars = solution_terms(cvs_gaze)[relevant_cov_cvsgaze])
```
<br/><br/>
The following covariates have predictive information (**relevant**): `(1 | subject)`, `time_outdoors`, `observer`, `sick_severity`, `sex`, `sociality`, `rearing`, `age`

# Session Info

```{r echo = F}
sessionInfo()
```







